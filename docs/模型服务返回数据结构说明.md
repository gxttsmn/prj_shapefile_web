# 模型服务返回数据结构说明

本文档明确：聊天功能收到的**模型服务（Dify 工作流）返回数据**的完整结构，以及前端如何解析、何时触发地图刷新。

---

## 一、数据流概览

```
用户输入 → 前端(ai-chat.js) → Dify Workflow API → 模型服务返回 JSON
                ↑
        解析 data.outputs / data.output 得到「回复文本」
                ↓
        parseAgentStatus(回复文本) 解析末尾 <<STATUS:SUCCESS>> / <<STATUS:FAILURE>>
                ↓
        若 status === 'SUCCESS' → 调用 window.reloadAllData() 刷新地图
        展示给用户的文本 = 回复文本去掉末尾状态标记
```

---

## 二、模型服务返回的原始结构（Dify Workflow API）

前端调用的是：`POST {DifyBaseUrl}/workflows/run`，响应为 JSON，根结构约定如下。

### 2.1 成功时

| 字段路径 | 类型 | 说明 |
|----------|------|------|
| `data` | object | 必填。工作流运行结果 |
| `data.id` | string | 运行 ID（可选） |
| `data.status` | string | 必填。`succeeded` 表示成功 |
| `data.outputs` | object | 推荐。多输出节点时，键为节点 ID，值为该节点输出 |
| `data.outputs.<nodeId>` | object/string | 某输出节点的内容 |
| `data.outputs.<nodeId>.output` | string/object | 该节点的 `output` 字段，前端会从此提取「回复文本」 |
| `data.output` | string/object | 单输出节点时可直接放在 data 下，与 outputs 二选一即可 |
| `data.error` | string | 失败时错误信息 |
| `data.message` | string | 失败时提示信息 |

前端提取「回复文本」的优先级（见 `parseDifyResponse`）：

1. `data.outputs` 下各节点的 `output` 字段（先取到非空字符串即返回）
2. `data.outputs` 下各节点的值本身（`extractOutputContent` 递归取字符串）
3. `data.output`
4. `data.result` / `data.content` / `data.message` / `data.text` / `data.answer` / `data.outputs`

**重要**：无论从哪一层取出，最终必须得到**一段字符串**，即「回复文本」。该字符串的格式见第三节。

### 2.2 失败时

- `data.status === 'failed'`
- 错误信息在 `data.error` 或 `data.message`，前端会抛出异常，不解析状态标记。

### 2.3 示例（仅作结构参考）

```json
{
  "data": {
    "id": "run-xxx",
    "status": "succeeded",
    "outputs": {
      "agent-node-id": {
        "output": "已成功创建名称为'张村'的要素，系统返回编号 gid=108。\n<<STATUS:SUCCESS>>"
      }
    }
  }
}
```

或单输出节点：

```json
{
  "data": {
    "status": "succeeded",
    "output": "未找到编号为 99 的记录，无法执行修改，请检查编号。\n<<STATUS:FAILURE>>"
  }
}
```

---

## 三、回复文本的约定格式（决定是否刷新地图）

从第二节得到的**回复文本**必须为**纯文本字符串**。前端用 `parseAgentStatus(text)` 仅根据**字符串末尾**判断是否执行了「写操作」并刷新地图。

### 3.1 操作成功（触发刷新）

- 在回复文本**末尾**增加一行或一段：**`<<STATUS:SUCCESS>>`**
- 允许末尾有换行、空格，再跟 `<<STATUS:SUCCESS>>`；正则：`/\s*<<STATUS:(SUCCESS|FAILURE)>>\s*$/`

**示例：**

```
已成功创建名称为'张村'的要素，系统返回编号 gid=108。

<<STATUS:SUCCESS>>
```

### 3.2 操作失败（不刷新）

- 在回复文本**末尾**增加：**`<<STATUS:FAILURE>>`**
- 前端不会刷新地图，仅展示去掉该标记后的文本。

**示例：**

```
未找到编号为 99 的记录，无法执行修改，请检查编号。

<<STATUS:FAILURE>>
```

### 3.3 无标记或仅对话

- 末尾无 `<<STATUS:SUCCESS>>` / `<<STATUS:FAILURE>>`：不刷新地图，正常展示全文。

### 3.4 前端对回复文本的处理

| 步骤 | 说明 |
|------|------|
| 1 | 从 Dify 返回的 `data.outputs` / `data.output` 等中解析出**回复文本**（字符串） |
| 2 | `parseAgentStatus(回复文本)` 得到 `{ displayText, status }` |
| 3 | 若 `status === 'SUCCESS'` 且存在 `window.reloadAllData`，则调用 `reloadAllData()` 刷新地图 |
| 4 | 聊天窗口展示 `displayText`（已去掉末尾 `<<STATUS:...>>`，用户不可见该标记） |

---

## 四、与 map_api.html 的配合

- `map_api.html` 在加载时定义 `reloadAllData()`，并挂到 `window.reloadAllData`。
- `reloadAllData()` 会清空并重新请求村庄、河渠、水系三层数据，并重算地图边界。
- 仅当页面为 `map_api.html`（即存在 `window.reloadAllData`）时，解析到 `<<STATUS:SUCCESS>>` 才会触发刷新；其他页面仅展示回复，不刷新。

---

## 五、模型侧需要保证的要点

1. **返回根结构**：HTTP 200，body 为 JSON，且包含 `data`；成功时 `data.status === 'succeeded'`。
2. **回复文本所在位置**：回复内容放在 `data.outputs.<节点ID>.output` 或 `data.output` 等前端会读取的任一字段中，且最终值为**字符串**。
3. **写操作后的标识**：对「创建/修改/删除」等会改变地图数据的操作，在该次回复的**字符串末尾**加上 `<<STATUS:SUCCESS>>`（成功）或 `<<STATUS:FAILURE>>`（失败），以便前端刷新地图或仅提示用户。

按上述结构返回后，前端无需修改即可正确解析并在操作成功时刷新地图。
