# Shapefile 数据结构详细说明

## 一、Shapefile 格式概述

**Shapefile** 是由 ESRI（Environmental Systems Research Institute）开发的一种地理矢量数据存储格式，广泛应用于 GIS（地理信息系统）领域。

### 核心特点

- **多文件格式**：一个完整的 shapefile 由多个文件组成（通常至少 3 个必需文件）
- **二进制格式**：主要文件使用二进制格式，提高存储和读取效率
- **分离存储**：几何数据和属性数据分开存储
- **广泛支持**：被几乎所有 GIS 软件和库支持

---

## 二、Shapefile 文件组成

### 必需文件（3 个核心文件）

#### 1. `.shp` 文件（Shape File - 几何数据文件）

**作用**：存储几何形状（点、线、面）的坐标数据

**数据结构**：
- **文件头（Header）**：100 字节
  - 文件编码（0-3）：固定为 9994
  - 未使用字段（4-31）：填充 0
  - 文件长度（32-35）：文件总长度（以 16 位字为单位，包括文件头）
  - 版本（36-39）：固定为 1000
  - 形状类型（40-43）：表示几何类型
    - 0 = Null Shape（空形状）
    - 1 = Point（点）
    - 3 = Polyline（线）
    - 5 = Polygon（面）
  - 边界框（44-99）：包含所有要素的最小外接矩形（Bounding Box）
    - Xmin, Ymin, Xmax, Ymax
    - Zmin, Zmax（3D 数据）
    - Mmin, Mmax（测量值）

- **记录（Record）**：每个几何要素一个记录
  - **记录头**（8 字节）
    - 记录号（4 字节）：从 1 开始
    - 记录长度（4 字节）：记录的数据长度（以 16 位字为单位）
  - **记录内容**：
    - 形状类型（4 字节）
    - 几何数据（根据类型不同而变化）

**点要素（Point）示例**：
```
形状类型: 1 (Point)
X 坐标: 8 字节 (双精度浮点数)
Y 坐标: 8 字节 (双精度浮点数)
```

**线要素（Polyline）示例**：
```
形状类型: 3 (Polyline)
边界框: 32 字节 (Xmin, Ymin, Xmax, Ymax)
部分数量: 4 字节 (整数)
点数量: 4 字节 (整数)
各部分起始索引: 数组
点坐标数组: X, Y 坐标对
```

**面要素（Polygon）示例**：
```
形状类型: 5 (Polygon)
边界框: 32 字节
部分数量: 4 字节
点数量: 4 字节
各部分起始索引: 数组
点坐标数组: X, Y 坐标对
```

---

#### 2. `.shx` 文件（Shape Index File - 索引文件）

**作用**：提供几何数据的快速访问索引

**数据结构**：
- **文件头**：100 字节（与 .shp 文件头相同）
- **索引记录**：每个几何要素一个索引记录（8 字节）
  - 偏移量（4 字节）：在 .shp 文件中的位置（以 16 位字为单位）
  - 内容长度（4 字节）：该记录的长度（以 16 位字为单位）

**意义**：
- 不读取完整文件即可快速定位特定要素
- 提高查询和读取性能
- 与 .shp 文件记录一一对应

**示例**：
```
索引记录 1: 偏移量=50, 长度=20   → 第 1 个要素从 .shp 文件第 50 个字开始，长 20 个字
索引记录 2: 偏移量=70, 长度=15   → 第 2 个要素从 .shp 文件第 70 个字开始，长 15 个字
```

---

#### 3. `.dbf` 文件（dBASE File - 属性数据文件）

**作用**：存储每个几何要素的属性信息（如名称、人口、分类等）

**数据结构**：
- **文件头**：描述表结构
  - 文件类型标识（1 字节）：03H 表示 dBASE III 格式
  - 最后更新日期（3 字节）：年（自 1900 起）、月、日
  - 记录数量（4 字节）：表中的记录数
  - 文件头长度（2 字节）：文件头部分的长度（以字节为单位）
  - 记录长度（2 字节）：每条记录的长度（以字节为单位）
  - 保留字段
  - 字段描述符数组：每个字段一个描述符（32 字节）
    - 字段名（11 字节，ASCII 码，以 0x00 结尾）
    - 字段类型（1 字节）：
      - 'C' = Character（字符）
      - 'N' = Numeric（数字）
      - 'F' = Float（浮点数）
      - 'D' = Date（日期）
      - 'L' = Logical（逻辑值）
      - 'M' = Memo（备注）
    - 字段长度（4 字节）：字段数据的长度
    - 小数位数（1 字节）：数字字段的小数位数
    - 其他字段标志

- **记录数据**：每条记录一行
  - 删除标志（1 字节）：0x20（空格）表示未删除，0x2A（*）表示已删除
  - 字段值：按字段定义顺序存储

**编码说明**：
- 中国大陆常用的编码：GBK、GB2312
- 国际通用编码：UTF-8、Latin-1
- 需要根据实际编码读取属性数据

**示例**（点_村.dbf 可能包含的字段）：
```
字段1: name (字符型, 长度100) - 村庄名称
字段2: population (数值型) - 人口数量
字段3: fclass (字符型, 长度28) - 要素分类
字段4: osm_id (字符型, 长度12) - OSM ID
```

---

### 可选文件

#### 4. `.prj` 文件（Projection File - 坐标系统定义）

**作用**：描述几何数据使用的坐标系统（CRS - Coordinate Reference System）

**格式**：文本文件，使用 WKT（Well-Known Text）格式

**内容示例**（本项目中的 .prj 文件）：
```
GEOGCS["GCS_WGS_1984",
       DATUM["D_WGS_1984",
             SPHEROID["WGS_1984",6378137.0,298.257223563]],
       PRIMEM["Greenwich",0.0],
       UNIT["Degree",0.0174532925199433]]
```

**解释**：
- `GEOGCS`：地理坐标系（Geographic Coordinate System）
- `GCS_WGS_1984`：世界大地测量系统 1984
- `DATUM`：基准面（D_WGS_1984）
- `SPHEROID`：椭球体
  - `WGS_1984`：椭球体名称
  - `6378137.0`：长半轴（米）
  - `298.257223563`：扁率倒数
- `PRIMEM`：本初子午线（Greenwich，0 度）
- `UNIT`：单位（度）

**EPSG 代码**：WGS 1984 的 EPSG 代码是 **4326**

**意义**：
- 正确显示地理位置
- 坐标系转换
- 地图投影
- 距离和面积计算

---

#### 5. `.shp.xml` 文件（XML 元数据）

**作用**：存储 shapefile 的详细元数据信息（符合 ISO 19139 标准）

**包含信息**：
- 数据来源
- 创建时间和修改时间
- 字段定义和描述
- 数据范围（边界框）
- 坐标系信息
- 创建工具和版本
- 数据质量信息

**格式**：XML 格式，使用 UTF-8 编码

**意义**：
- 数据文档化
- 数据共享和理解
- 数据质量管理

---

#### 6. `.sbn` 和 `.sbx` 文件（空间索引文件）

**作用**：提供空间索引，用于快速空间查询

**结构**：
- `.sbn`：空间索引的节点（Node）数据
- `.sbx`：空间索引的索引数据

**功能**：
- 快速查找特定区域内的要素
- 空间查询优化（如"查找某个矩形范围内的所有要素"）
- 提高大型数据集的处理效率

**注意**：
- 如果这两个文件损坏或丢失，可以重新生成
- 不影响基本功能，只影响空间查询性能

---

## 三、几何数据类型

### 1. 点（Point）要素

**形状类型代码**：1

**数据结构**：
- X 坐标（双精度浮点数，8 字节）
- Y 坐标（双精度浮点数，8 字节）

**示例**：村庄位置、标记点、GPS 坐标

**特点**：
- 最简单的几何类型
- 只包含一个坐标点
- 没有长度和面积

**在项目中的应用**：
- `点_村.shp` - 存储村庄的位置坐标

---

### 2. 线（Polyline）要素

**形状类型代码**：3

**数据结构**：
- 边界框（Bounding Box）
  - Xmin, Ymin, Xmax, Ymax（各 8 字节）
- 部分数量（整数，4 字节）：线的分段数
- 点数量（整数，4 字节）：所有点的总数
- 各部分起始索引（整数数组）：每个部分在点数组中的起始位置
- 点坐标数组：所有点的 X, Y 坐标对

**多部分线（MultiPart）**：
- 一条线可以包含多个不连续的部分
- 例如：同一条河流在不同区域被分割

**示例**：道路、河流、边界线

**在项目中的应用**：
- `线_河渠.shp` - 存储河渠的路径坐标

**特点**：
- 有长度，没有面积
- 可以包含多个线段
- 第一个点和最后一个点可以不同（开放线段）

---

### 3. 面（Polygon）要素

**形状类型代码**：5

**数据结构**：
- 边界框（Bounding Box）
- 部分数量（整数，4 字节）：多边形的环（Ring）数量
- 点数量（整数，4 字节）：所有点的总数
- 各部分起始索引（整数数组）
- 点坐标数组：所有点的 X, Y 坐标对

**多边形环（Ring）**：
- **外环（Outer Ring）**：定义多边形边界，点顺序为逆时针
- **内环（Inner Ring）**：定义孔洞，点顺序为顺时针

**多部分多边形（MultiPart）**：
- 一个要素可以包含多个不连接的多边形
- 例如：一个湖泊在多个区域有水体

**示例**：湖泊、行政边界、建筑轮廓

**在项目中的应用**：
- `面_水系.shp` - 存储水系（如湖泊、池塘）的边界坐标

**特点**：
- 有长度（周长）和面积
- 可以包含孔洞（如岛屿）
- 外环必须闭合（第一个点 = 最后一个点）

---

## 四、属性数据结构

### DBF 文件字段类型

| 类型代码 | 类型名称 | 说明 | 示例 |
|---------|---------|------|------|
| C | Character | 文本字符串 | "北京市", "村庄A" |
| N | Numeric | 整数或小数 | 12345, 123.45 |
| F | Float | 浮点数 | 123.456 |
| D | Date | 日期 (YYYYMMDD) | 20240101 |
| L | Logical | 布尔值 (T/F) | T, F |
| M | Memo | 备注（存储在单独文件） | - |

### 字段定义示例

以 `点_村.dbf` 为例，可能包含以下字段：

```
字段名: name
类型: Character (C)
长度: 100
说明: 村庄名称

字段名: population
类型: Numeric (N)
长度: 10
小数位: 0
说明: 人口数量

字段名: fclass
类型: Character (C)
长度: 28
说明: 要素分类（如 "village", "town"）
```

---

## 五、Shapefile 与记录对应关系

### 一对一对齐

Shapefile 中的几何数据和属性数据通过**记录顺序**对应：

```
.shp 文件记录 1  ←→  .dbf 文件记录 1  ←→  .shx 文件索引 1
.shp 文件记录 2  ←→  .dbf 文件记录 2  ←→  .shx 文件索引 2
.shp 文件记录 3  ←→  .dbf 文件记录 3  ←→  .shx 文件索引 3
...
```

**重要规则**：
- 三个文件中的记录数量**必须相同**
- 记录顺序**必须一致**
- 删除一条记录时，需要在所有文件中同步删除

---

## 六、坐标系统说明

### WGS 1984 (EPSG:4326)

**本项目中所有 shapefile 使用的坐标系统**

**特点**：
- **类型**：地理坐标系（Geographic Coordinate System）
- **单位**：度（Degree）
- **基准面**：WGS 1984
- **范围**：
  - 经度：-180° 到 +180°
  - 纬度：-90° 到 +90°

**坐标格式**：
- 经度（Longitude，X）：东经为正，西经为负
- 纬度（Latitude，Y）：北纬为正，南纬为负

**示例**：
- 北京：约 (116.4°, 39.9°)
- 上海：约 (121.5°, 31.2°)
- 本项目数据（山西运城）：约 (111°, 35°)

**使用场景**：
- GPS 坐标
- Web 地图（如 Google Maps、OpenStreetMap）
- 国际数据交换

---

## 七、实际数据示例分析

### 点_村.shp（村庄点数据）

**文件组成**：
- `点_村.shp` - 84 个点的坐标
- `点_村.shx` - 84 个索引记录
- `点_村.dbf` - 84 条属性记录（包含 name, population, fclass 等字段）
- `点_村.prj` - WGS 1984 坐标系定义

**数据结构**：
```
记录 1:
  几何: (111.123, 35.456)  ← 村庄坐标
  属性: name="村A", population=1000, fclass="village"
```

### 线_河渠.shp（河渠线数据）

**文件组成**：
- `线_河渠.shp` - 5 条线的坐标序列
- `线_河渠.shx` - 5 个索引记录
- `线_河渠.dbf` - 5 条属性记录（包含 name 字段）
- `线_河渠.prj` - WGS 1984 坐标系定义

**数据结构**：
```
记录 1:
  几何: [(111.1, 35.1), (111.2, 35.2), (111.3, 35.3), ...]  ← 河渠路径
  属性: name="河渠A"
```

### 面_水系.shp（水系面数据）

**文件组成**：
- `面_水系.shp` - 56 个多边形的坐标序列
- `面_水系.shx` - 56 个索引记录
- `面_水系.dbf` - 56 条属性记录（包含 name, fclass 等字段）
- `面_水系.prj` - WGS 1984 坐标系定义

**数据结构**：
```
记录 1:
  几何: [(111.1, 35.1), (111.2, 35.1), (111.2, 35.2), (111.1, 35.2), (111.1, 35.1)]  ← 闭合多边形
  属性: name="湖泊A", fclass="lake"
```

---

## 八、Shapefile 的局限性

### 1. 文件大小限制

- **最大文件大小**：2 GB（因为使用 32 位整数存储长度）
- **最大要素数量**：理论无限制，但受文件大小限制
- **属性字段限制**：最多 255 个字段

### 2. 字段类型限制

- **字符字段长度**：最长 254 个字符
- **不支持复杂数据类型**：如数组、对象
- **日期格式固定**：YYYYMMDD

### 3. 性能问题

- **大量小要素**：读写效率低
- **空间查询**：需要空间索引文件（.sbn/.sbx）才能高效
- **网络传输**：多个文件需要打包（通常使用 .zip）

### 4. 功能限制

- **不支持拓扑关系**：需要单独存储
- **不支持 3D 几何**：只有简单的 Z 坐标支持
- **不支持复杂几何**：如曲线、曲面

---

## 九、Shapefile 读取流程

### 标准读取流程

1. **读取索引文件（.shx）**
   - 获取所有要素的偏移量和长度
   - 确定要素数量

2. **读取属性文件（.dbf）**
   - 读取文件头，了解字段定义
   - 读取属性数据

3. **读取几何文件（.shp）**
   - 根据索引定位到特定要素
   - 解析几何数据

4. **读取坐标系统（.prj）**（如果存在）
   - 解析 WKT 格式
   - 设置坐标参考系统

5. **合并数据**
   - 将几何数据和属性数据按记录号合并
   - 形成完整的要素数据

---

## 十、常见问题解答

### Q1: 为什么需要多个文件？

**A**: Shapefile 设计时为了：
- **分离关注点**：几何和属性分开存储
- **提高性能**：可以只读取需要的部分
- **向后兼容**：保持与旧系统的兼容性

### Q2: 缺少某个文件会怎样？

| 文件 | 缺少的影响 |
|------|-----------|
| .shp | **完全无法使用** - 没有几何数据 |
| .shx | **可以使用，但性能差** - 无法快速定位要素 |
| .dbf | **几何可用，但无属性** - 所有属性为空 |
| .prj | **可用，但坐标系统未知** - 可能显示位置错误 |
| .sbn/.sbx | **可用，但空间查询慢** - 不影响基本功能 |
| .shp.xml | **可用** - 只是缺少元数据 |

### Q3: 如何判断 Shapefile 的编码？

**A**: 
- 查看文件来源（中国大陆常用 GBK）
- 尝试多种编码读取
- 检查 .shp.xml 文件中的字符集信息
- 使用工具检测文件编码

### Q4: Shapefile 可以存储 3D 数据吗？

**A**: 
- Shapefile 支持 Z 坐标（高程）
- 但 3D 功能有限
- 复杂的 3D 几何建议使用其他格式（如 GeoPackage）

### Q5: 如何优化大型 Shapefile？

**A**:
- 使用空间索引（.sbn/.sbx）
- 简化几何（减少顶点数量）
- 裁剪不需要的区域
- 考虑转换为其他格式（如 GeoPackage、PostGIS）

---

## 十一、相关技术标准

### 技术规范

- **Shapefile 技术规范**：ESRI Shapefile Technical Description
- **DBF 格式**：dBASE III/IV 文件格式
- **WKT 格式**：OGC WKT-CRS 标准
- **元数据标准**：ISO 19139

### 相关格式

- **GeoJSON**：基于 JSON 的开放标准
- **GeoPackage**：SQLite 基础上的地理数据格式
- **KML**：Google 开发的 XML 格式
- **GPKG**：OGC GeoPackage 标准

---

## 十二、总结

Shapefile 是一种成熟、广泛支持的地理数据格式，虽然有一些局限性，但在 GIS 领域仍然占据重要地位。理解其文件结构和数据组织方式，有助于：

- ✅ 正确读取和处理数据
- ✅ 理解数据存储和查询机制
- ✅ 解决编码和格式问题
- ✅ 优化数据处理性能
- ✅ 进行数据格式转换

---


**文档版本**：1.0  
**最后更新**：2025-01-20

